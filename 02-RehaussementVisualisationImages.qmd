---
jupyter: python3
execute:
  echo: true
  eval: false
  message: false
  warning: false
---

# R√©haussement et visualisation d'images {#sec-chap02}

## :rocket: Pr√©ambule
### :dart: Objectifs
Dans ce chapitre, nous abordons quelques techniques de r√©haussement et de visualisation d'images. Ce chapitre est aussi disponible sous la forme d'un notebook Python:
[![](https://colab.research.google.com/assets/colab-badge.svg)](https://colab.research.google.com/github/sfoucher/TraitementImagesPythonVol1/blob/main/notebooks/02-RehaussementVisualisationImages.ipynb){target="_blank"} 

### Librairies
Les librairies qui vont √™tre explor√©es dans ce chapitre sont les suivantes:

* SciPy 

* NumPy 

* OpenCV

* RasterIO 

* Geemap

* [rioxarray](https://corteva.github.io/rioxarray/stable/index.html)

* xarray 



Dans l'environnement Google Colab, seul `rioxarray` et GDAL doivent √™tre install√©s:
```{python}
%%capture
!apt-get update
!apt-get install gdal-bin libgdal-dev
!pip install -q rioxarray
!pip install -qU "geemap[workshop]"
```
### Donn√©es

Nous allons utilis√©s ces images dans ce chapitre:
```{python}
!wget https://github.com/sfoucher/TraitementImagesPythonVol1/raw/refs/heads/main/data/chapitre01/subset_RGBNIR_of_S2A_MSIL2A_20240625T153941_N0510_R011_T18TYR_20240625T221903.tif -O RGBNIR_of_S2A.tif
!wget https://github.com/sfoucher/opengeos-data/raw/refs/heads/main/raster/landsat7.tif -O landsat7.tif
```

## R√©haussements visuels

Le but du r√©haussement visuel d'une image vise principalement √† am√©liorer la qualit√© visuelle d'une image en am√©liorant le contraste, la dynamique ou la texture d'une image. De mani√®re g√©n√©rale, ce r√©haussement ne modifie pas la donn√©e d'origine mais est plut√¥t appliqu√©e dynamiquement √† l'affichage pour des fins d'inspection visuelle.

### Statistiques d'une image

On peut consid√©rer un ensemble de statistique globales pour chacune des bandes d'une image:
- valeurs minimales et maximales
- valeurs moyennes, m√©dianes et quantiles
- √©cart-types, skewness et kurtosis 
Ces statistiques doivent √™tre calcul√©es pour chaque bande d'une image multispectrale.

En ligne de commande, `gdalinfo` permet d'interroger rapidement un fichier image pour connaitre les statistiques de base:
```{python}
#| lst-label: lst-gdalstats
#| lst-cap: Statistiques d'une image avec gdal
#| eval: true

!gdalinfo -stats landsat7.tif
```

Les librairies de base comme `xarray` et `numpy` peuvent facilement produire des statistiques comme avec la fonction [stats](https://rasterio.readthedocs.io/en/stable/api/rasterio.io.html#rasterio.io.BufferedDatasetWriter.stats):

```{python}
#| eval: false

import rasterio as rio
import numpy as np
with rio.open('landsat7.tif') as src:
    stats= src.stats()
    print(stats)
```


La librairie `xarray` donne acc√®s √† des fonctionnalit√©s plus sophistiqu√©es comme le calcul des quantiles:
```{python}
#| eval: true

import rioxarray as riox
with riox.open_rasterio('landsat7.tif', masked= True) as src:
    print(src)
quantiles = src.quantile(dim=['x','y'], q=[.025,.25,.5,.75,.975])
quantiles
```



#### Calcul de l'histogramme

Le calcul d'un histogramme pour une image (une bande) permet d'avoir une vue plus d√©taill√©e de la r√©partition des valeurs radiom√©triques. Le calcul d'un histogramme n√©cessite minimalement de faire le choix d'une valeur du nombre de *bins* (ou de la largeur). Un *bin* est un intervalle de valeurs pour lequel on peut calculer le nombre de valeurs observ√©es dans l'image. La fonction de base pour ce type de calcul est la fonction `numpy.histogram()`:
```{python}
#| eval: true
import numpy as np
array = np.random.randint(0,10,100) # 100 valeurs al√©atoires entre 0 et 10
hist, bin_limites = np.histogram(array, density=True)
print('valeurs :',hist)
print(';imites :',bin_limites)
```
Le calcul se fait avec 10 intervalles par d√©faut.

Pour des besoins de visualisation, le calcul des valeurs extr√™mes de l'histogramme peut aussi se faire via les quantiles comme discut√©s auparavant.

##### Visualisation des histogrammes

La librarie `rasterio` est probablement l'outil le plus simples pour visualiser rapidement des histogrammes sur une image multi-spectrale:
```{python}
#| eval: true
import rasterio as rio
from rasterio.plot import show_hist
with rio.open('RGBNIR_of_S2A.tif') as src:
  show_hist(src, bins=50, lw=0.0, stacked=False, alpha=0.3,histtype='stepfilled', title="Histogram")
```

### R√©haussements lin√©aires

Le r√©haussement lin√©aire d'une image est la forme la plus simple de r√©haussement, elle consiste 1) √† optimiser les valeurs des pixels d'une image afin de maximiser la dynamique disponibles √† l'affichage, ou 2) changer le format de stockage des valeurs (e.g. de 8 bit √† 16 bit):

$$ \text{nouvelle valeur d'un pixel} = \frac{\text{valeur d'un pixel} - min_0}{max_0 - min_0}\times (max_1 - min_1)+min_1$$
Par cette op√©ration, on passe de la dynamique de d√©part ($max_0 - min_0$) vers la dynamique cible ($max_1 - min_1$). Bien que cette op√©ration semble triviale, il est important d'√™tre conscient des trois contraintes suivantes:
1. **Faire attention √† la dynamique cible**, ainsi, pour sauvegarder une image en format 8 bit, on utilisera alors $max_1=255$ et $min_1=0$.
2. **Pr√©servation de la valeur de no data** : il faut faire attention √† la valeur $min_1$ dans le cas d'une valeur pr√©sente pour *no_data*. Par exemple, si *no_data=0* alors il faut s'assurer que $min_1>0$.
3. **Pr√©cision du calcul** : si possible r√©aliser la division ci-dessus en format *float*

### R√©haussements non lin√©aires


Calcul d'histogrammes, √©tirement, √©galisation, styling

### Compos√©s couleurs

Le syst√®me visuel humain est sensible seulement √† la partie visible du spectre √©lectromagn√©tique qui compose les couleurs de l'arc-en-ciel du bleu au rouge. L'ensemble des couleurs du spectre visible peut √™tre obtenu √† partir du m√©lange de trois couleurs primaires (rouge, vert et bleu). Ce syst√®me de d√©composition √† trois couleurs est √† la base de la plupart des syst√®mes de visualisation ou de repr√©sentation de l'information de couleur. On peut trouver des variantes comme le syst√®me HSV (*Hue-Saturation-Value*) utilis√© en encodage de donn√©es vid√©os.

## Visualisation

### Visualisation en Python

Il faut d'entr√©e mentionner que Python n'est pas vraiment fait pour visualiser de la donn√©e de grande taille, le niveau d'interactivit√© est aussi plus limit√©. N√©anmoins, il est possible de visualiser de petites images avec la librairie Matplotlib. 

### Outils de visualisation

Il existe plusieurs outils gratuits de visualisation d'une image satellite, on peut mentionner les deux principaux:
- QGIS
- ESA Snap


### Visualisation sur le Web

Une des meilleures pratiques pour visualiser une image de grande taille est d'utiliser un service de type Web Mapping Service (WMS). Cependant, type de service n√©cessite une architecture client-serveur qui est plus complexe √† mettre en place.

Google Earth Engine offre des moyens de visualiser de la donn√©e locale:
üîñ _Working with Local Geospatial Data_ ‚Äî via [17. Geemap ‚Äî Introduction to GIS Programming](https://geog-312.gishub.org/book/geospatial/geemap.html#working-with-local-geospatial-data)

üîñ __ ‚Äî via [data/raster at main ¬∑ opengeos/data](https://github.com/opengeos/data/tree/main/raster)



### Visualisation 3D

drapper une image satellite sur un DEM


## Quiz de r√©vision du chapitre

## Exercices de r√©vision 


